#lang racket

; get the list of all text files in a directory
(define (list-text-files-in-directory directory-path)
  (filter (lambda (file)
            (string-suffix? file ".txt"))
          (map (lambda (file) (path->string (build-path directory-path file)))
               (directory-list directory-path))))

; read a histogram text file and return the values in a list
(define (read-hist-file filename) 
  (call-with-input-file filename
    (lambda (p)
      (letrec ((f (lambda (x)
                    (if (eof-object? x) '() (cons x (f (read p)))))))
        (cdr (f (read p)))))))

; calculate the similarity between two histograms
(define (calculate-similarity hist1 hist2)
  (if (or (null? hist1) (null? hist2))
      0
      (+ (abs (- (car hist1) (car hist2))) (calculate-similarity (cdr hist1) (cdr hist2)))))

; find the five most similar images along with their filenames and similarity scores
(define (find-most-similar-images query-histogram all-histograms)
  (define sorted-similarities
    (sort all-histograms
          (lambda (a b)
            (< (calculate-similarity (cdr query-histogram) (cdr a))
               (calculate-similarity (cdr query-histogram) (cdr b))))))

  (take sorted-similarities 5))

; read all histograms from a directory
(define (read-all-histograms directory)
  (map (lambda (filename)
         (cons filename (read-hist-file filename)))
       (list-text-files-in-directory directory)))

; the main function
(define (similaritySearch queryHistogramFilename imageDatasetDirectory)
  (let* ((query-histogram (cons queryHistogramFilename (read-hist-file queryHistogramFilename)))
         (all-histograms (read-all-histograms imageDatasetDirectory))
         (similar-images (find-most-similar-images query-histogram all-histograms)))
    (if (null? similar-images)
        '()
        (let ((max-score (apply max (map cdr similar-images))))
          (map (lambda (x)
                 (let ((filename (car x))
                       (score (/ (cdr x) max-score)))
                   (list filename score)))
               similar-images)))))



; Example call of similaritySearch:
;(similaritySearch "C:\\Users\\benha\\OneDrive\\Bureau\\Uni\\Hiver2024\\CSI2520\\P4\\queryImages\\q00.jpg.txt" "C:\\Users\\benha\\OneDrive\\Bureau\\Uni\\Hiver2024\\CSI2520\\P4\\imageDataset2_15_20")
